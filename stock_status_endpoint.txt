# Add new endpoint to server.py after stock/all endpoint

@app.route('/api/locations/stock_status_simple', methods=['GET'])
def get_locations_stock_status_simple():
    """
    Returns simplified stock status for each location: green or red only
    Green = all drugs at location meet min stock
    Red = one or more drugs below min stock
    """
    with get_db() as conn:
        cursor = conn.cursor()
        
        # Get all locations
        locations = cursor.execute("SELECT id FROM locations").fetchall()
        
        status_map = {}
        
        for loc in locations:
            loc_id = loc['id']
            
            # Check if any drug at this location is below min stock
            below_min = cursor.execute("""
                SELECT COUNT(*) as count
                FROM stock_levels sl
                WHERE sl.location_id = ?
                AND (
                    SELECT COUNT(*) 
                    FROM vials v 
                    WHERE v.location_id = sl.location_id 
                    AND v.drug_id = sl.drug_id 
                    AND v.status = 'AVAILABLE'
                ) < sl.min_stock
            """, (loc_id,)).fetchone()
            
            # Green if no drugs below min, Red if any drug below min
            status_map[loc_id] = 'critical' if below_min['count'] > 0 else 'healthy'
        
        return jsonify(status_map)
